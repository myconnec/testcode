<div class="col-md-8 col-md-offset-2">
    <div class="row">
        <div class="panel panel-default">

            <div class="panel-heading">
                <h2>Upload Media for New Listing</h2>
                <div class="red">Acceptable file types are avi, .mov, .mp4, or .mkv .</div>
            </div>

            <div class="panel-body">

                <%= simple_form_for(@listing,html: {
                    authenticity_token: true,
                    data: {
                        'form-data' => (@s3_direct_post.fields),
                        'url' => @s3_direct_post.url,
                        'host' => URI.parse(@s3_direct_post.url).host
                    },
                    class: 'form-horizontal ',
                    id: 'new_listing_upload',
                    multipart: true
                }) do |f| %>

                    <%# source https://stevenyue.com/blogs/validate-attachment-file-size-and-type-in-rails/ %>
                    <%# source http://www.seanbehan.com/onchange-event-fired-from-select-field-in-rails-form/ %>

                    <%= f.file_field :listing,
                        accept: ".avi, .mov, .mp4, .mkv",
                        class:"form-control",
                        id: "fileupload",
                        required: true,
                        type: "file"
                    %>

                    <div id="listing_media_info"></div>
                    <br>

                    <div id="listing_media_progress"></div>

                    <div class="input-group">
                        <div class="actions">
                            <%= f.submit "Submit Media", class: "btn btn-success", id: "listings_submit" %>
                        </div>
                    </div>

                <% end %>

            </div>
        </div>
    </div>
</div>

<%= render "processing_overlay" %>

<script>
$(function () {
    var media_file = [];

    document.getElementById('fileupload').onchange = setFileInfo;

    function setFileInfo() {
        var files = this.files;
        media_file.push(files[0]);
        var video = document.createElement('video');
        video.preload = 'metadata';

        video.onloadedmetadata = function() {
            var duration = video.duration;
            media_file[media_file.length - 1].duration = duration;
            var infos = document.getElementById('listing_media_info');
            infos.textContent = "";
            for (var i = 0; i < media_file.length; i++) {
                // infos.textContent += media_file[i].name + " duration: " + media_file[i].duration + '\n';
                infos.textContent = "Duration: " + sec2time(media_file[i].duration) + '\n';
            }
        }

        function sec2time(timeInSeconds) {
            var pad = function(num, size) { return ('000' + num).slice(size * -1); },
            time = parseFloat(timeInSeconds).toFixed(3),
            hours = Math.floor(time / 60 / 60),
            minutes = Math.floor(time / 60) % 60,
            seconds = Math.floor(time - minutes * 60),
            milliseconds = time.slice(-3);
        
            // return pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2) + ',' + pad(milliseconds, 3);
            return  minutes + ' minutes and ' + pad(seconds, 2) + ' seconds.';
        }

        video.src = URL.createObjectURL(files[0]);
    }
    
    $('#listings_submit').on('click', function () {
        if (document.getElementById('new_listing_upload').checkValidity() == true){
            $("#overlay").toggle()
        }
    });
});
</script>

