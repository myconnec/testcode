---
- hosts: all
  become: true
  gather_facts: false

  pre_tasks:
    - name: Update dependencies via apt-get
      raw: sudo apt-get clean && apt-get autoclean && sudo apt autoremove -y && sudo apt-get update -y

    - name: Installing awscli, https transport, build-essential, Python & PIP
      raw: sudo apt-get install -y awscli apt-transport-https build-essential python-minimal python-setuptools python-pip software-properties-common

  tasks:
    - name: Install system dependencies
      apt: name={{ item }} state=present
      with_items:
        - git
        - curl
        - zlib1g-dev
        - libreadline-dev
        - libcurl4-openssl-dev
        - libffi-dev
        - libreadline6-dev
        - curl
        - zlib1g
        - zlib1g-dev
        - zlib1g-dev 

    - name: Install NodeJs and NPM
      apt: name={{ item }} state=present
      with_items:
        - nodejs 
        - nodejs-dev 
        - node-gyp 
        - npm

    # Source: https://github.com/wakproductions/ansible-examples/blob/master/roles/install-ruby241/tasks/main.yml
    
    - name: Install dependencies specificly for Ruby 2.3.8
      apt: name={{ item }} state=present
      with_items:
        - libyaml-dev
        - libxml2-dev
        - libxslt-dev
        - libsqlite3-dev
        - autoconf
        - libc6-dev
        - ncurses-dev
        - automake
        - libtool
        - bison
        - subversion
        - zlib1g # http://askubuntu.com/questions/59205/no-such-file-to-load-zlib-error-when-installing-a-gem
        - zlib1g-dev  # error while installing bundler: http://stackoverflow.com/questions/9727908/cannot-load-such-file-zlib-even-after-using-rvm-pkg-install-zlib
        - libssl-dev

    # Ruby source, build, install, clean up

    - name: Create a working directory
      file:
        path:  /tmp/build_ruby
        state: directory
        mode: 'u+rwx'

    - name: Download Ruby 2.3.8
      get_url:
        url:  https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.8.tar.gz
        dest: /tmp/build_ruby/ruby-2.3.8.tar.gz

    - name: Unpack Ruby 2.3.8
      unarchive:
        src: /tmp/build_ruby/ruby-2.3.8.tar.gz
        dest: /tmp/build_ruby/
        remote_src: yes

    - name: Build ruby
      command: >
        {{ item }}
        chdir=/tmp/build_ruby/ruby-2.3.8
        creates=/usr/local/bin/ruby
      with_items:
        - ./configure --enable-shared
        - make
        - make install

    - name: Add ruby symlinks
      file:
        src: "/usr/local/bin/{{ item }}"
        dest: "/usr/bin/{{ item }}"
        state: link
        force: yes
      with_items:
        - erb
        - gem
        - irb
        - rake
        - rdoc
        - ruby

    - name: Remove the working directory
      file:
        path:  /tmp/build_ruby
        state: absent

    # # MySQL client

    - name: Install system dependencies
      apt: name={{ item }} state=present
      with_items:
        - mysql-client
        - libmysqlclient-dev

    - git_config:
        name: credential.helper
        value: '!aws codecommit credential-helper $@'

    - git_config:
        name: credential.UseHttpPath
        value: true

    - git:
        accept_hostkey: yes
        remote: origin
        depth: 1
        dest: /home/ubuntu/ConnecHub
        repo: https://git-codecommit.us-east-1.amazonaws.com/v1/repos/ConnecHub
        version: master

    - name: Install bunbler and gems
      shell: |
        cd /home/ubuntu/ConnecHub && gem install bundler -v 1.3.5 && ./bin/bundle install

    - name: Change ownership of web app dir
      file:
        path: /home/ubuntu/ConnecHub
        group: ubuntu
        owner: ubuntu
        recurse: true

    - name: Start Rails server
      become: ubuntu
      shell: |
        cd /home/ubuntu/ConnecHub && rails server -d --binding 0.0.0.0
