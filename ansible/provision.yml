---
- hosts: all
  vars:
    RUBY_VERSION: 2.3.8

    local_group: ubuntu
    local_user: ubuntu

    version: master

  # TODO use root only when really needed
  become: true
  gather_facts: false

  pre_tasks:
    - name: dpkg config
      shell: |
        export DEBIAN_FRONTEND=noninteractive
        dpkg --configure -a

    - name: apt-get config and update
      shell:  |
        curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
        curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
        echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
        apt-get update -y
        apt-get clean -y
        apt-get autoclean -y
        apt autoremove -y

  tasks:
    - name: 
      apt:
        update_cache: true
        pkg:
          - awscli
          - apt-transport-https
          - autoconf
          - automake
          - bison
          - build-essential
          - curl
          - git-core
          - imagemagick
          - libc6-dev
          - libffi-dev
          - libmysqlclient-dev
          - libreadline-dev
          - libreadline6-dev
          - libsqlite3-dev
          - libssl1.0-dev 
          - libtool
          - libxml2-dev
          - libxslt-dev
          - libxslt1-dev 
          - libyaml-dev
          - mysql-client
          - ncurses-dev
          - node-gyp
          - nodejs
          - python3
          - python3-pip
          - s3fs
          - software-properties-common
          - sqlite3
          - subversion
          - yarn
          - zlib1g
        state: present

    # source: https://linuxize.com/post/how-to-add-swap-space-on-ubuntu-18-04/
    - name: Add swap disk to instance
      shell: |
        swapon --show
        dd if=/dev/zero of=/swapfile bs=1024 count=1048576
        chmod 600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        swapon --show
        free -h

    - name: Install Ruby {{ RUBY_VERSION }}
      become: "{{ local_user }}"
      shell: |
        git clone https://github.com/rbenv/rbenv.git ~/.rbenv
        echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(rbenv init -)"' >> ~/.bashrc
        git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
        echo 'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"' >> ~/.bashrc
        .rbenv/libexec/rbenv install {{ RUBY_VERSION }}
        .rbenv/libexec/rbenv global {{ RUBY_VERSION }}

    - name: Tools and version output
      become: "{{ local_user }}"
      shell: |
        echo "git: $(git --version)" >> tool_versions.txt
        echo "python: $(python3 --version)" >> tool_versions.txt
        echo "pip: $(pip3 --version)" >> tool_versions.txt
        echo "node: $(node --version)" >> tool_versions.txt
        echo "npm: $(npm --version)" >> tool_versions.txt
        echo "yarn: $(yarn --version)" >> tool_versions.txt
        echo "rbenv: $(rbenv --version)" >> tool_versions.txt
        echo "ruby: $(ruby --version)" >> tool_versions.txt
